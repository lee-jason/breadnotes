name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Create environment file
      run: |
        cat > breadnotes.env << EOF
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION=${{ secrets.AWS_REGION }}
        S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
        CLOUDFRONT_DOMAIN=${{ secrets.CLOUDFRONT_DOMAIN }}
        FRONTEND_URL=${{ secrets.FRONTEND_URL }}
        EOF

    - name: Debug environment file
      run: |
        ls -la breadnotes.env
        echo "--- breadnotes.env contents ---"
        cat breadnotes.env
        echo "--- end breadnotes.env ---"

    - name: Copy environment file to EC2
      run: |
        echo "Attempting to copy breadnotes.env file..."
        scp -v -i ~/.ssh/id_rsa breadnotes.env ec2-user@${{ secrets.EC2_HOST }}:/tmp/breadnotes.env
        echo "scp exit code: $?"

    - name: Copy deployment script to EC2
      run: |
        scp -i ~/.ssh/id_rsa scripts/deploy.sh ec2-user@${{ secrets.EC2_HOST }}:/tmp/deploy.sh

    - name: Verify files copied to EC2
      run: |
        ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          echo "/tmp directory permissions:"
          ls -ld /tmp
          echo "All files in /tmp:"
          ls -la /tmp/
          echo "Looking for our specific files:"
          ls -la /tmp/*.env /tmp/*.sh 2>/dev/null || echo "Some files missing"
          echo "Checking breadnotes.env file specifically:"
          if [ -f /tmp/breadnotes.env ]; then
            echo "breadnotes.env exists, size: $(stat -c%s /tmp/breadnotes.env)"
            echo "First few lines of breadnotes.env:"
            head -3 /tmp/breadnotes.env
          else
            echo "breadnotes.env file does not exist"
          fi
        EOF

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          # Move and rename environment file to application directory
          sudo mv /tmp/breadnotes.env /opt/breadnotes/.env
          sudo chown breadnotes:breadnotes /opt/breadnotes/.env
          sudo chmod 600 /opt/breadnotes/.env
          
          # Make deployment script executable and run it
          chmod +x /tmp/deploy.sh
          sudo /tmp/deploy.sh
        EOF

    - name: Verify deployment
      run: |
        sleep 10
        ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          # Check if service is running
          if sudo systemctl is-active --quiet breadnotes; then
            echo "✓ BreadNotes service is running"
            
            # Optional: Test if the service responds
            if curl -f -m 10 http://localhost:8000/ > /dev/null 2>&1; then
              echo "✓ API is responding"
            else
              echo "⚠ API is not responding (might be normal for some endpoints)"
            fi
          else
            echo "✗ BreadNotes service is not running"
            sudo systemctl status breadnotes --no-pager -l
            exit 1
          fi
        EOF